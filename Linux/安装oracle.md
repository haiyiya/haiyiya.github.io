# 安装 oracle



# 下载 oracle 11g

### 下载

linux.x64_11gR2_database_1of2.zip

linux.x64_11gR2_database_2of2.zip

> [oracle10G/11G官方迅雷下载地址合集 - 淼淼之森 - 博客园 (cnblogs.com)](https://www.cnblogs.com/mmzs/p/9030823.html)

### 上传至服务器

使用 winscp，如上传至 /usr/local/tools 下

### 解压至当前目录

```bash
unzip linux.x64_11gR2_database_1of2.zip
unzip linux.x64_11gR2_database_2of2.zip
```

> 需安装 unzip

解压出的文件夹为 /usr/local/tools/database

# 关闭 selinux

```bash
vi /etc/selinux/config
SELINUX=disabled
# 验证
setenforce 0
```

# 安装 oracle 11g 依赖包

```bash
# 安装依赖包
yum install gcc make binutils gcc-c++ compat-libstdc++-33elfutils-libelf-devel elfutils-libelf-devel-static ksh libaio libaio-develnumactl-devel sysstat unixODBC unixODBC-devel pcre-devel –y
# 检查缺失的安装包
rpm -q --queryformat %-{name}-%{version}-%{release}-%{arch}"\n" \ compat-libstdc++-33 glibc-kernheaders glibc-headers libaio libgcc glibc-devel xorg-x11-deprecated-libs
```

> 离线环境参看[Linux/配置本地yum源](Linux/配置本地yum源.md)

# 添加 oracle 用户和用户组

```
groupadd oinstall
groupadd dba
useradd -g oinstall -G dba oracle
passwd oracle
```



# 配置 sysctl.conf 系统参数

```
vi /etc/sysctl.conf
```

在末尾添加

```properties

fs.aio-max-nr = 1048576
fs.file-max = 6815744
kernel.shmall = 2097152
kernel.shmmax = 1073741824
kernel.shmmni = 4096
kernel.sem = 250 32000 100 128
net.ipv4.ip_local_port_range = 9000 65500
net.core.rmem_default = 262144
net.core.rmem_max = 4194304
net.core.wmem_default = 262144
net.core.wmem_max = 1048576 
```

>  **kernel.shmmax ：**
>
> 单位 byte，是核心参数中最重要的参数之一，用于定义单个共享内存段的最大值。设置应该足够大，能在一个共享内存段下容纳下整个的 SGA，最大值为物理内存 - 1 byte，建议设置为物理内存的一半。
>
> **kernel.shmall ：**
>
> 该参数控制可以使用的共享内存的总页数。 Linux 共享内存页大小为 4KB, 共享内存段的大小都是共享内存页大小的整数倍。一个共享内存段的最大大小是 16G ，那么需要共享内存页数是 16GB/4KB==4194304 （页）
<br>当内存为 12G 时， kernel.shmall = 3145728
<br>当内存为 16G 时， kernel.shmall = 4194304
<br>当内次为 32G 时， kernel.shmall = 8388608
<br>当内存为 64G 时， kernel.shmall = 16777216
<br>当内存为 128G 时， kernel.shmall = 33554432
> 
> 版权声明：本文为CSDN博主「不会推车的娘们」的原创文章，遵循CC 4.0 BY-SA版权协议，转载请附上原文出处链接及本声明。
> 原文链接：https://blog.csdn.net/shmily_lsl/article/details/103384366

```bash
# 生效
sysctl -p
```

# 修改用户的限制文件

### /etc/security/limits.conf

```bash
vi /etc/security/limits.conf
```

在末尾添加

```bash
oracle           soft    nproc           2047
oracle           hard    nproc           16384
oracle           soft    nofile          1024
oracle           hard    nofile         65536
oracle           soft    stack           10240 
```

### /etc/pam.d/login

```bash
vi /etc/pam.d/login
```

在末尾添加

```bash
session required  /lib64/security/pam_limits.so
session required   pam_limits.so 
```

### /etc/profile

```bash
vi /etc/profile
```

在末尾添加

```sh
#oracle配置
if [ $USER = "oracle" ]; then
  if [ $SHELL = "/bin/ksh" ]; then
      ulimit -p 16384
      ulimit -n 65536
  else
      ulimit -u 16384 -n 65536
  fi
fi 
```



# 创建安装目录

```bash
mkdir -p /usr/local/oracle/product/11.2.0/db_1
mkdir /usr/local/oracle/oradata
mkdir /usr/local/oracle/inventory
mkdir /usr/local/oracle/fast_recovery_area
chown -R oracle:oinstall /usr/local/oracle
chmod -R 775 /usr/local/oracle
# 授权安装目录
chmod -R 777 /usr/local/tools/database
```

# 设置 oracle 用户环境变量

```bash
# 切换至oracle用户
su -l oracle
vi .bash_profile
```

在末尾添加

```sh
ORACLE_BASE=/usr/local/oracle
ORACLE_HOME=$ORACLE_BASE/product/11.2.0/db_1
ORACLE_SID=orcl
PATH=$PATH:$ORACLE_HOME/bin
export ORACLE_BASE ORACLE_HOME ORACLE_SID PATH
# 刷新 .bash_profile
source .bash_profile
```

> ORACLE_SID 必须与创建的数据库实例名称一致



# 安装 oracle

> 无图形界面，采用静默安装方式

### 编辑安装响应文件

```bash
# 切换至oracle用户
su -l oracle
# 备份安装相应文件
cd /usr/local/tools/database
mkdir response_bak
cp response/* response_bak 
# 编辑安装响应文件
vi response/db_install_rsp
```

```properties
oracle.install.option=INSTALL_DB_SWONLY
ORACLE_HOSTNAME=
UNIX_GROUP_NAME=oinstall
INVENTORY_LOCATION=/usr/local/oracle/inventory
SELECTED_LANGUAGES=en,zh_CN
ORACLE_HOME=/usr/local/oracle/product/11.2.0/db_1
ORACLE_BASE=/usr/local/oracle
oracle.install.db.InstallEdition=EE
oracle.install.db.DBA_GROUP=dba
oracle.install.db.OPER_GROUP=dba
# 安全更新，因oracle 11g bug，必须设为true
DECLINE_SECURITY_UPDATES=true
```

> `ORACLE_HOSTNAME`是否来自环境变量 $HOSTNAME ?，测试留空则为 localhost（tnsnames.ora）

### 安装

```bash
cd /usr/local/tools/database/
./runInstaller -silent -responseFile /usr/local/tools/database/response/db_install.rsp -ignorePrereq
```



# 配置监听

```bash
# 切换到oracle用户
su -l oracle
netca /silent /responseFile /usr/local/tools/database/response/netca.rsp
```

> 注意此处，必须使用`/silent /responseFile`格式，而不是`-silent -responseFile`，因为是静默安装。

打印`Oracle Net Services configuration successful. The exit code is 0`，说明运行成功；在 $ORACLE_HOME/network/admin 中生成 listener.ora 和 sqlnet.ora

```properties
# listener.ora Network Configuration File: /usr/local/oracle/product/11.2.0/db_1/network/admin/listener.ora
# Generated by Oracle configuration tools.

LISTENER =
  (DESCRIPTION_LIST =
    (DESCRIPTION =
      (ADDRESS = (PROTOCOL = IPC)(KEY = EXTPROC1522))
      (ADDRESS = (PROTOCOL = TCP)(HOST = localhost)(PORT = 1522))
    )
  )

ADR_BASE_LISTENER = /usr/local/oracle
```

### 查看监听状态

```bash
[oracle@localhost response]$ lsnrctl status

LSNRCTL for Linux: Version 11.2.0.1.0 - Production on 27-JUL-2021 23:08:24

Copyright (c) 1991, 2009, Oracle.  All rights reserved.

Connecting to (DESCRIPTION=(ADDRESS=(PROTOCOL=IPC)(KEY=EXTPROC1521)))
STATUS of the LISTENER
------------------------
Alias                     LISTENER
Version                   TNSLSNR for Linux: Version 11.2.0.1.0 - Production
Start Date                27-JUL-2021 17:10:39
Uptime                    0 days 5 hr. 57 min. 45 sec
Trace Level               off
Security                  ON: Local OS Authentication
SNMP                      OFF
Listener Parameter File   /usr/local/oracle/product/11.2.0/db_1/network/admin/listener.ora
Listener Log File         /usr/local/oracle/diag/tnslsnr/localhost/listener/alert/log.xml
Listening Endpoints Summary...
  (DESCRIPTION=(ADDRESS=(PROTOCOL=ipc)(KEY=EXTPROC1521)))
  (DESCRIPTION=(ADDRESS=(PROTOCOL=tcp)(HOST=localhost)(PORT=1521)))
Services Summary...
Service "orcl" has 1 instance(s).
  Instance "orcl", status READY, has 1 handler(s) for this service...
Service "orclXDB" has 1 instance(s).
  Instance "orcl", status READY, has 1 handler(s) for this service...
The command completed successfully
```



### 查看 1521 端口监听

```bash
netstat -tnulp | grep 1521
```

# 创建数据库实例

### 编辑响应文件

```bash
# 切换到oracle用户
su -l oracle
vi /usr/local/tools/database/response/dbca.rsp
```



```properties
[GENERAL]

# oracle版本，不能更改
RESPONSEFILE_VERSION = "11.2.0"

# Description   : Type of operation，安装类型为创建数据库
OPERATION_TYPE = "createDatabase"

[CREATEDATABASE]

# Description   : Global database name of the database
# 全局数据库的名字=SID+主机域名
# 第三方工具链接数据库的时候使用的service名称
GDBNAME = "ORCL"

# Description   : System identifier (SID) of the database
# 对应的实例名字
SID = "orcl"

# Description   : Name of the template
# 建库用的模板文件
TEMPLATENAME = "General_Purpose.dbc"

# Description   : Password for SYS user
# SYS管理员密码
SYSPASSWORD = "123456"

# Description   : Password for SYSTEM user
# SYSTEM管理员密码
SYSTEMPASSWORD = "123456"

# Description   : Password for SYSMAN user
# SYSMAN管理员密码
SYSMANPASSWORD = "123456"

# Description   : Password for DBSNMP user
# DBSNMP管理员密码
DBSNMPPASSWORD = "123456"

# Description   : Location of the data file's
# 数据文件存放目录
DATAFILEDESTINATION =/usr/local/oracle/oradata

# Description   : Location of the data file's
# 恢复数据存放目录
RECOVERYAREADESTINATION=/usr/local/oracle/fast_recovery_area

# Description   : Character set of the database
# 字符集，重要!!! 建库后一般不能更改，所以建库前要确定清楚。
# (CHARACTERSET = "AL32UTF8" NATIONALCHARACTERSET= "UTF8")
CHARACTERSET = "ZHS16GBK"

# Description   : total memory in MB to allocate to Oracle
# oracle内存1638MB,物理内存2G*80%
# 不，此处应保留默认值800
# 不，这里注释即可，让oracle自己选择memory_max_target和memory_target
# TOTALMEMORY = "800" 
```

> `GDBNAME`表示服务名，service_name，在 \$ORACLE_HOME/network/admin/tnsnames.ora中可查看，如 plsql 中使用`192.168.3.127:1521/ORCL`连接数据库
>
> ```properties
> # tnsnames.ora Network Configuration File: /usr/local/oracle/product/11.2.0/db_1/network/admin/tnsnames.ora
> # Generated by Oracle configuration tools.
> 
> ORCL =
>   (DESCRIPTION =
>     (ADDRESS = (PROTOCOL = TCP)(HOST = localhost)(PORT = 1521))
>     (CONNECT_DATA =
>       (SERVER = DEDICATED)
>       (SERVICE_NAME = ORCL)
>     )
>   )
> ```



> `DATAFILEDESTINATION`表空间文件默认位置，`select * from dba_data_files`可查看，如 system 表空间位置为`/home/oracle/oradata/orcl/system01.dbf`



> `OTALMEMORY`应保留默认值 800，不然调整`memory_target`，启动时报`ORA-00838: Specified value of MEMORY_TARGET is too small`或`ORA-00845: MEMORY_TARGET not supported on this system`

### 创建数据库实例

```bash
dbca -silent -responseFile /usr/local/tools/database/response/dbca.rsp
```

打印 100% complete 说明创建完成

### 查看实例

确认实例 orcl`STATUS`为 OPEN

```bash
SQL> select * from v$instance;

INSTANCE_NUMBER INSTANCE_NAME
--------------- ----------------
HOST_NAME
----------------------------------------------------------------
VERSION           STARTUP_T STATUS       PAR    THREAD# ARCHIVE LOG_SWITCH_WAIT
----------------- --------- ------------ --- ---------- ------- ---------------
LOGINS     SHU DATABASE_STATUS   INSTANCE_ROLE      ACTIVE_ST BLO
---------- --- ----------------- ------------------ --------- ---
              1 orcl
localhost.localdomain
11.2.0.1.0        27-JUL-21 OPEN         NO           1 STOPPED
ALLOWED    NO  ACTIVE            PRIMARY_INSTANCE   NORMAL    NO
```

### 检查进程

```bash
ps -ef | grep ora_ | grep -v grep
```



# 连接数据库

```bash
# 连接数据库
sqlplus / as sysdba
```

### 检查自动内存管理

```bash
show parameter memory
```

如`memory_max_target`和`memory_target`为0，说明 dbca.rsp 中的`TOTALMEMORY`配置有误（过大？），此时调整将无法启动

# 调整内存

```bash
alter system set memory_max_target = 60G scope = spfile;
alter system set memory_target = 52G scope = spfile;
shutdown immediate;
startup;
```

> oracle 11g 有自动内存调整，只需调整`memory_max_target`和`memory_target`大小即可，值不要超过物理内存的 3/4，且不能超过`/dev/shm`大小

##### 调整前

```sql
SQL> show parameter memory

NAME                                 TYPE        VALUE
------------------------------------ ----------- ------------------------------
hi_shared_memory_address             integer     0
memory_max_target                    big integer 51712M
memory_target                        big integer 51712M
shared_memory_address                integer     0
SQL> show sga

Total System Global Area 5.3982E+10 bytes
Fixed Size                  2218032 bytes
Variable Size            2.9528E+10 bytes
Database Buffers         2.4428E+10 bytes
Redo Buffers               24133632 bytes
SQL> show parameter sga

NAME                                 TYPE        VALUE
------------------------------------ ----------- ------------------------------
lock_sga                             boolean     FALSE
pre_page_sga                         boolean     FALSE
sga_max_size                         big integer 51712M
sga_target                           big integer 0
SQL> show parameter pga

NAME                                 TYPE        VALUE
------------------------------------ ----------- ------------------------------
pga_aggregate_target                 big integer 0
SQL>
```

##### 调整后

```sql
SQL> show parameter memory

NAME                                 TYPE        VALUE
------------------------------------ ----------- ------------------------------
hi_shared_memory_address             integer     0
memory_max_target                    big integer 60G
memory_target                        big integer 51712M
shared_memory_address                integer     0
SQL> show sga

Total System Global Area 6.4137E+10 bytes
Fixed Size                  2219552 bytes
Variable Size            3.9997E+10 bytes
Database Buffers         2.3891E+10 bytes
Redo Buffers              247029760 bytes
SQL> show parameter sga

NAME                                 TYPE        VALUE
------------------------------------ ----------- ------------------------------
lock_sga                             boolean     FALSE
pre_page_sga                         boolean     FALSE
sga_max_size                         big integer 60G
sga_target                           big integer 0
SQL> show parameter pga

NAME                                 TYPE        VALUE
------------------------------------ ----------- ------------------------------
pga_aggregate_target                 big integer 0
SQL>
```

### 调整内存无法启动解决办法

##### ORA-00838: Specified value of MEMORY_TARGET is too small 或 ORA-00845: MEMORY_TARGET not supported on this system

创建实例时响应文件 dbca.ora 时设置了`TOTALMEMORY`，经测试，注释该配置，让 oracle 自行配置合适的大小，或保留默认值800，之后再调整内存

##### ORA-00845: MEMORY_TARGET not supported on this system

> `memory_max_target`小于 shm 分区，shm分区（mounted on `/dev/shm`）默认为物理内存的一半，可尝试增大该分区🥱

重建 spfile

```bash
sqlplus / as sysdba
# 重建 spfile
create spfile from pfile
# 启动
startup
```

如重建 spfile 提示 initorcl.ora 文件不存在

```bash
# 切换到oracle用户
su -l oracle
# 拷贝initorcl.ora
cp /usr/local/oracle/admin/orcl/pfile/init.ora.xxxx /usr/oracle/product/11.2.0/orcl/dbs/initorcl.ora
```

> cp 到 $ORACLE_HOME/orcl/dbs/initorcl.ora ?



##### 如遇到无法关闭也无法重启的情况

```bash
shutdown abort
```



# 数据初始化

参看 [数据库/oracle/sqlplus](数据库/oracle/sqlplus.md)



# 开机启动监听和实例

### /etc/oratab

$ORACLE_HOME/bin/dbstart 根据 oratab 来启动实例

```bash
[oracle@localhost /]$  vi /etc/oratab 
orcl:/usr/local/oracle/product/11.2.0/db_1:Y
```

### /etc/rc.d/rc.local

在 rc.local 中添加启动监听和实例的命令

```bash
[root@localhost ~]# cat /etc/rc.d/rc.local
#!/bin/bash
# THIS FILE IS ADDED FOR COMPATIBILITY PURPOSES
#
# It is highly advisable to create own systemd services or udev rules
# to run scripts during boot instead of using this file.
#
# In contrast to previous versions due to parallel execution during boot
# this script will NOT be run after all other services.
#
# Please note that you must run 'chmod +x /etc/rc.d/rc.local' to ensure
# that this script will be executed during boot.

touch /var/lock/subsys/local
su - oracle -c "/usr/local/oracle/product/11.2.0/db_1/bin/lsnrctl start"
su - oracle -c "/usr/local/oracle/product/11.2.0/db_1/bin/dbstart startup"
```



> **oratab**
>
> oratab文件是在创建数据库实例时建立的，在安装时使用root用户执行root.sh脚本后得到。（如果忘记也可以直接手动创建。）
>
> 在\$ORACLE_HOME/bin目录下的\$ORACLE_HOME/bin/dbstart和\$ORACLE_HOME/bin/dbshut需要调用/etc/oratab文件，如果不存在，dbstart和dbshut将失败，报错信息为/etc/oratab" is notaccessible。
>
> oratab的格式为： `ORACLE＿SID:ORACLE_HOME:AUTO`
>
> 如 果需要自动启动数据库，则将AUTO设为Y，在调用dbstart命令才生效。dbstart根据/etc/oratab中的配置来启动相应的数据库，选 项只是能不能用\$ORACLE_HOME/bin/dbstart和\$ORACLE_HOME/bin/dbshut来启动和关闭数据库的开关。
>
> 如果不用dbstart脚本启动数据库，而是用自己的脚本来启动，根本不需要oratab文件。
>
> **dbstart**
>
> dbstart是安装数据库时自带的启动数据库实例的脚本，默认存放在\$oracle_home/bin下。在这里我们通过设置系统开机自动执行dbstart脚本文件来实现，开机自动启动数据实例。
>
> **lsnrctl**
>
> lsnrctl是安装数据库时自带的启动数据库监听的脚本，默认存放在\$oracle_home/bin下。在这里我们通过设置系统开机自动执行lsnrctl脚本文件来实现，开机自动启动数据监听
>
> **rc.local**
>
> rc.local系统自带的是开机启动程序脚本，默认存放在/etc/rc.d下。我们通过在rc.local脚本中添加执行启动数据库和启动监听的脚本来实现开机自动开启数据库实例和监听。

> 如开机启动失效，参看 [Linux/开机启动](Linux/开机启动.md)
>

# 删除实例

### 编辑响应文件

修改/usr/local/tools/database/response/dbca.rsp文件里以下几个参数，下面三个参数根据建库实际情况进行修改：

```properties
# 操作类型为删除数据库
OPERATION_TYPE = "deleteDatabase"
SOURCEDB = "orcl"
SYSDBAUSERNAME = "sys"
SYSDBAPASSWORD = "123456"
```

### 删除实例

```bash
dbca -silent -responseFile /usr/local/tools/database/response/dbca.rsp
```

> ORA-00845: MEMORY_TARGET not supported on this system
>
> 调整内存无法启动解决办法

# 卸载数据库

### 使用 deinstall 工具卸载

```bash
// 切换到oracle用户
su -l oracle
cd $ORACLE_HOME
cd deinstall
./deinstall
```

> 全部卸载：在 `Do you want` 或者 `y or n` 的地方输入 y，其余地方按回车

> Oracle官方推荐的做法是使用后者，也就是专门的删除工具。原因是内置的deinstall工具脚本中常常带有很多bug，很多时候不能完全的将其删除干净。特别是Windows环境下的卸载工具，不能正常工作的场景很多。
>
> [使用Deinstall专用工具删除Oracle Database_ITPUB博客](http://blog.itpub.net/17203031/viewspace-711809/)

# 疑难问题

### 切换用户报 su: warning: cannot change directory to /home/postgres: No such file or directory

根目录或用户主目录不存在或权限不够

```bash
# 如oracle主目录/usr/local/oracle不存在
mkdir /usr/local/oracle
chmod 775 /usr/local/oracle
# 初始化
cp -a /etc/skel/. /home/oracle
su -l oracle
```

### ORA-12514: TNS :监听程序当前无法识别连接描述符中请求的服务

ip、服务名不对

