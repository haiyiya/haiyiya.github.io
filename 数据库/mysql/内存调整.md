# 内存调整

> mysql 配置文件为 my.ini，默认位置：C:\ProgramData\MySQL\MySQL Server 5.7\my.ini

# 默认配置

```ini
# Other default tuning values
# MySQL Server Instance Configuration File
# ----------------------------------------------------------------------
# Generated by the MySQL Server Instance Configuration Wizard
#
#
# Installation Instructions
# ----------------------------------------------------------------------
#
# On Linux you can copy this file to /etc/my.cnf to set global options,
# mysql-data-dir/my.cnf to set server-specific options
# (@localstatedir@ for this installation) or to
# ~/.my.cnf to set user-specific options.
#
# On Windows you should keep this file in the installation directory 
# of your server (e.g. C:\Program Files\MySQL\MySQL Server X.Y). To
# make sure the server reads the config file use the startup option 
# "--defaults-file". 
#
# To run run the server from the command line, execute this in a 
# command line shell, e.g.
# mysqld --defaults-file="C:\Program Files\MySQL\MySQL Server X.Y\my.ini"
#
# To install the server as a Windows service manually, execute this in a 
# command line shell, e.g.
# mysqld --install MySQLXY --defaults-file="C:\Program Files\MySQL\MySQL Server X.Y\my.ini"
#
# And then execute this in a command line shell to start the server, e.g.
# net start MySQLXY
#
#
# Guildlines for editing this file
# ----------------------------------------------------------------------
#
# In this file, you can use all long options that the program supports.
# If you want to know the options a program supports, start the program
# with the "--help" option.
#
# More detailed information about the individual options can also be
# found in the manual.
#
# For advice on how to change settings please see
# http://dev.mysql.com/doc/refman/5.7/en/server-configuration-defaults.html
#
#
# CLIENT SECTION
# ----------------------------------------------------------------------
#
# The following options will be read by MySQL client applications.
# Note that only client applications shipped by MySQL are guaranteed
# to read this section. If you want your own MySQL client program to
# honor these values, you need to specify it as an option during the
# MySQL client library initialization.
#
[client]

# pipe
# socket=0.0
port=3306

[mysql]
no-beep

default-character-set=utf8


# SERVER SECTION
# ----------------------------------------------------------------------
#
# The following options will be read by the MySQL Server. Make sure that
# you have installed the server correctly (see above) so it reads this 
# file.
#
# server_type=2
[mysqld]

# The next three options are mutually exclusive to SERVER_PORT below.
# skip-networking

# enable-named-pipe

# shared-memory

# shared-memory-base-name=MYSQL

# The Pipe the MySQL Server will use
# socket=MYSQL

# The TCP/IP Port the MySQL Server will listen on
port=3306

# Path to installation directory. All paths are usually resolved relative to this.
# basedir="C:/Program Files/MySQL/MySQL Server 5.7/"

# Path to the database root
datadir=C:/ProgramData/MySQL/MySQL Server 5.7/Data

# The default character set that will be used when a new schema or table is
# created and no character set is defined
character-set-server=utf8

# The default storage engine that will be used when create new tables when
default-storage-engine=INNODB

# Set the SQL mode to strict
sql-mode="STRICT_TRANS_TABLES,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION"

# Enable Windows Authentication
# plugin-load=authentication_windows.dll

# General and Slow logging.
log-output=FILE
general-log=0
general_log_file="OA.log"
slow-query-log=1
slow_query_log_file="OA-slow.log"
long_query_time=10

# Binary Logging.
# log-bin

# Error Logging.
log-error="OA.err"

# Server Id.
server-id=1

# Secure File Priv.
secure-file-priv="C:/ProgramData/MySQL/MySQL Server 5.7/Uploads"

# The maximum amount of concurrent sessions the MySQL server will
# allow. One of these connections will be reserved for a user with
# SUPER privileges to allow the administrator to login even if the
# connection limit has been reached.
max_connections=151

# The number of open tables for all threads. Increasing this value
# increases the number of file descriptors that mysqld requires.
# Therefore you have to make sure to set the amount of open files
# allowed to at least 4096 in the variable "open-files-limit" in
# section [mysqld_safe]
table_open_cache=2000

# Maximum size for internal (in-memory) temporary tables. If a table
# grows larger than this value, it is automatically converted to disk
# based table This limitation is for a single table. There can be many
# of them.
tmp_table_size=16M

# How many threads we should keep in a cache for reuse. When a client
# disconnects, the client's threads are put in the cache if there aren't
# more than thread_cache_size threads from before.  This greatly reduces
# the amount of thread creations needed if you have a lot of new
# connections. (Normally this doesn't give a notable performance
# improvement if you have a good thread implementation.)
thread_cache_size=10

#*** MyISAM Specific options
# The maximum size of the temporary file MySQL is allowed to use while
# recreating the index (during REPAIR, ALTER TABLE or LOAD DATA INFILE.
# If the file-size would be bigger than this, the index will be created
# through the key cache (which is slower).
myisam_max_sort_file_size=100G

# If the temporary file used for fast index creation would be bigger
# than using the key cache by the amount specified here, then prefer the
# key cache method.  This is mainly used to force long character keys in
# large tables to use the slower key cache method to create the index.
myisam_sort_buffer_size=8M

# Size of the Key Buffer, used to cache index blocks for MyISAM tables.
# Do not set it larger than 30% of your available memory, as some memory
# is also required by the OS to cache rows. Even if you're not using
# MyISAM tables, you should still set it to 8-64M as it will also be
# used for internal temporary disk tables.
key_buffer_size=8M

# Size of the buffer used for doing full table scans of MyISAM tables.
# Allocated per thread, if a full scan is needed.
read_buffer_size=0

read_rnd_buffer_size=0

#*** INNODB Specific options ***
# innodb_data_home_dir=0.0

# Use this option if you have a MySQL server with InnoDB support enabled
# but you do not plan to use it. This will save memory and disk space
# and speed up some things.
# skip-innodb

# If set to 1, InnoDB will flush (fsync) the transaction logs to the
# disk at each commit, which offers full ACID behavior. If you are
# willing to compromise this safety, and you are running small
# transactions, you may set this to 0 or 2 to reduce disk I/O to the
# logs. Value 0 means that the log is only written to the log file and
# the log file flushed to disk approximately once per second. Value 2
# means the log is written to the log file at each commit, but the log
# file is only flushed to disk approximately once per second.
innodb_flush_log_at_trx_commit=1

# The size of the buffer InnoDB uses for buffering log data. As soon as
# it is full, InnoDB will have to flush it to disk. As it is flushed
# once per second anyway, it does not make sense to have it very large
# (even with long transactions).
innodb_log_buffer_size=1M

# InnoDB, unlike MyISAM, uses a buffer pool to cache both indexes and
# row data. The bigger you set this the less disk I/O is needed to
# access data in tables. On a dedicated database server you may set this
# parameter up to 80% of the machine physical memory size. Do not set it
# too large, though, because competition of the physical memory may
# cause paging in the operating system.  Note that on 32bit systems you
# might be limited to 2-3.5G of user level memory per process, so do not
# set it too high.
innodb_buffer_pool_size=8M

# Size of each log file in a log group. You should set the combined size
# of log files to about 25%-100% of your buffer pool size to avoid
# unneeded buffer pool flush activity on log file overwrite. However,
# note that a larger logfile size will increase the time needed for the
# recovery process.
innodb_log_file_size=48M

# Number of threads allowed inside the InnoDB kernel. The optimal value
# depends highly on the application, hardware as well as the OS
# scheduler properties. A too high value may lead to thread thrashing.
innodb_thread_concurrency=49

# The increment size (in MB) for extending the size of an auto-extend InnoDB system tablespace file when it becomes full.
innodb_autoextend_increment=64

# The number of regions that the InnoDB buffer pool is divided into.
# For systems with buffer pools in the multi-gigabyte range, dividing the buffer pool into separate instances can improve concurrency,
# by reducing contention as different threads read and write to cached pages.
innodb_buffer_pool_instances=8

# Determines the number of threads that can enter InnoDB concurrently.
innodb_concurrency_tickets=5000

# Specifies how long in milliseconds (ms) a block inserted into the old sublist must stay there after its first access before
# it can be moved to the new sublist.
innodb_old_blocks_time=1000

# It specifies the maximum number of .ibd files that MySQL can keep open at one time. The minimum value is 10.
innodb_open_files=300

# When this variable is enabled, InnoDB updates statistics during metadata statements.
innodb_stats_on_metadata=0

# When innodb_file_per_table is enabled (the default in 5.6.6 and higher), InnoDB stores the data and indexes for each newly created table
# in a separate .ibd file, rather than in the system tablespace.
innodb_file_per_table=1

# Use the following list of values: 0 for crc32, 1 for strict_crc32, 2 for innodb, 3 for strict_innodb, 4 for none, 5 for strict_none.
innodb_checksum_algorithm=0

# The number of outstanding connection requests MySQL can have.
# This option is useful when the main MySQL thread gets many connection requests in a very short time.
# It then takes some time (although very little) for the main thread to check the connection and start a new thread.
# The back_log value indicates how many requests can be stacked during this short time before MySQL momentarily
# stops answering new requests.
# You need to increase this only if you expect a large number of connections in a short period of time.
back_log=80

# If this is set to a nonzero value, all tables are closed every flush_time seconds to free up resources and
# synchronize unflushed data to disk.
# This option is best used only on systems with minimal resources.
flush_time=0

# The minimum size of the buffer that is used for plain index scans, range index scans, and joins that do not use
# indexes and thus perform full table scans.
join_buffer_size=256K

# The maximum size of one packet or any generated or intermediate string, or any parameter sent by the
# mysql_stmt_send_long_data() C API function.
max_allowed_packet=4M

# If more than this many successive connection requests from a host are interrupted without a successful connection,
# the server blocks that host from performing further connections.
max_connect_errors=100

# Changes the number of file descriptors available to mysqld.
# You should try increasing the value of this option if mysqld gives you the error "Too many open files".
open_files_limit=4161

# If you see many sort_merge_passes per second in SHOW GLOBAL STATUS output, you can consider increasing the
# sort_buffer_size value to speed up ORDER BY or GROUP BY operations that cannot be improved with query optimization
# or improved indexing.
sort_buffer_size=256K

# The number of table definitions (from .frm files) that can be stored in the definition cache.
# If you use a large number of tables, you can create a large table definition cache to speed up opening of tables.
# The table definition cache takes less space and does not use file descriptors, unlike the normal table cache.
# The minimum and default values are both 400.
table_definition_cache=1400

# Specify the maximum size of a row-based binary log event, in bytes.
# Rows are grouped into events smaller than this size if possible. The value should be a multiple of 256.
binlog_row_event_max_size=8K

# If the value of this variable is greater than 0, a replication slave synchronizes its master.info file to disk.
# (using fdatasync()) after every sync_master_info events.
sync_master_info=10000

# If the value of this variable is greater than 0, the MySQL server synchronizes its relay log to disk.
# (using fdatasync()) after every sync_relay_log writes to the relay log.
sync_relay_log=10000

# If the value of this variable is greater than 0, a replication slave synchronizes its relay-log.info file to disk.
# (using fdatasync()) after every sync_relay_log_info transactions.
sync_relay_log_info=10000

# Indicates how is the InnoDB Cluster configured as (Classic, Sandbox, Master or Slave).
# innodbclustertypeselection=ClassicMySQLReplication

# Indicates how is the InnoDB Cluster is/will be named.
# innodbclustername="sandboxCluster"

# Indicates how many instances will the InnoDB cluster sandbox will have.
# innodbclusterinstances=0

# Holds the InnoDB Cluster Username.
# innodbclusterusername

# Indicates the InnoDB Cluster URI.
# innodbclusteruri

# Indicates the InnoDB Cluster Port.
# innodbclusterport=3306

# Load mysql plugins at start."plugin_x ; plugin_y".
# plugin_load

# MySQL server's plugin configuration.
# loose_mysqlx_port=33060
```

# 配置优化

### max_connections

最大连接数

### innodb_buffer_pool_size

默认值 8M？，设为 8G

> `innodb_buffer_pool_size`默认大小为128M。最大值取决于CPU的架构。在32-bit平台上，最大值为`2**32 -1`,在64-bit平台上最大值为`2**64-1`。当缓冲池大小大于1G时，将`innodb_buffer_pool_instances`设置大于1的值可以提高服务器的可扩展性。
>
> 大的缓冲池可以减小多次磁盘I/O访问相同的表数据。在专用数据库服务器上，可以将缓冲池大小设置为服务器物理内存的60%-80%。

### sort_buffer_size

默认值 256K，设为 2M

> **sort_buffer_size是一个connection级参数，在每个connection第一次需要使用这个buffer的时候，一次性分配设置的内存。**并不是越大越好，由于是connection级的参数，过大的设置+高并发可能会耗尽系统内存资源。官方文档推荐范围为256KB~2MB。
>
> [MySQL中的sort_buffer_size参数大小的设置问题 - MSSQL123 - 博客园 (cnblogs.com)](https://www.cnblogs.com/wy123/p/7744171.html)
>
> [sort_buffer_size参数--mysql - 知乎 (zhihu.com)](https://zhuanlan.zhihu.com/p/272003699)

### join_buffer_size

默认值 256K，设为 2M

> Join Buffer 可被用于联接是ALL、index、和range的类型;每次联接使用一个Join Buffer，因此多表的联接可以使用多个Join Buffer；Join Buffer在联接发生之前进行分配，在SQL语句执行完后进行释放；Join Buffer只存储要进行查询操作的相关列数据，而不是整行的记录。
>
> 
>
> 作者：尹楷楷
> 链接：https://www.jianshu.com/p/3c0816862cc9
> 来源：简书
> 著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。

> mysql使用到join_buffer的一些注意事项：
>
> 1、只有当sql语句explain的结果type为ALL、index、range才会使用到join_buffer_size；
>
> 2、当有多个表进行join的时候会为每个join分别分配join_buffer_size，所以一个查询有可能分配多个join_buffer_size；
>
> 3、join_buffer只会缓存使用到的行数据，不会缓存多余的行数据
>
> 4、当无法分配足够的内存空间给join_buffer的时候，mysql不会报错，也不会警告，查询会继续执行，只是没有使用join_buffer。
>
> [参数join_buffer_size跟explain结果type的部分联系-visician-ChinaUnix博客](http://blog.chinaunix.net/uid-26253010-id-4039457.html)

### read_buffer_size

测试对查询貌似不影响

> 来自国外博客的一篇文章介绍了MySQL 的 read_buffer_size 参数是如何影响写缓冲和写性能。
>
> 据说 read_buffer_size 参数只影响以下两种情况的写数据的性能：
>
> - SELECT INTO … OUTFILE `fileName`
>   - When writing to the OUTFILE, the writes are buffered before writing to OUTFILE
> - When [filesort](http://dev.mysql.com/doc/refman/5.1/en/order-by-optimization.html) is used, during merge buffers and when merged results are written to a temporary file, then writes are buffered
>
> 下表是该文章测试的一些数据：
>
> | read_buffer_size      | physical writes | exe time in secs |
> | --------------------- | --------------- | ---------------- |
> | =0 (defaults to 8200) | 23495           | 28.39            |
> | =131072 (default)     | 2937            | 27.44            |
> | =16777216             | 23              | 26.71            |
> | =33554432             | 12              | 26.00            |
> | =536870912            | 1               | 26.72            |
>
> [MySQL 的 read_buffer_size 参数是如何影响写缓冲和写性能的？ - seasonzone - 博客园 (cnblogs.com)](https://www.cnblogs.com/seasonzone/p/4090376.html)
>
> [How read_buffer_size Impacts Write Buffering and Write Performance | Venu Anuganti Blog (venublog.com)](http://venublog.com/2010/06/23/how-read_buffer_size-impacts-write-buffering-and-write-performance/)

### key_buffer_size

key_buffer_size是对MyISAM表性能影响最大的一个参数，下面一台以MyISAM为主要存储引擎服务器的配置：

```sql
mysql> SHOW VARIABLES LIKE '%key_buffer_size%';
```

下面查看key_buffer_size的使用情况：

```sql
mysql> SHOW GLOBAL STATUS LIKE '%key_read%';
+-------------------+-----------------+
| Variable_name     | Value           |
+-------------------+-----------------+
| Key_read_requests | 2454354135490   |
| Key_reads         | 23490           |
+-------------------+-----------------+
2 rows in set (0.00 sec)
```

一共有Key_read_requests个索引请求，一共发生了Key_reads次物理IO

Key_reads/Key_read_requests ≈ 0.1%以下比较好。

> [MySQL优化小案例：key_buffer_size - 艾森豪威迩 - 博客园 (cnblogs.com)](https://www.cnblogs.com/xiaoit/p/4438220.html)

### 调整后的my.ini

```ini
# Other default tuning values
# MySQL Server Instance Configuration File
# ----------------------------------------------------------------------
# Generated by the MySQL Server Instance Configuration Wizard
#
#
# Installation Instructions
# ----------------------------------------------------------------------
#
# On Linux you can copy this file to /etc/my.cnf to set global options,
# mysql-data-dir/my.cnf to set server-specific options
# (@localstatedir@ for this installation) or to
# ~/.my.cnf to set user-specific options.
#
# On Windows you should keep this file in the installation directory 
# of your server (e.g. C:\Program Files\MySQL\MySQL Server X.Y). To
# make sure the server reads the config file use the startup option 
# "--defaults-file". 
#
# To run run the server from the command line, execute this in a 
# command line shell, e.g.
# mysqld --defaults-file="C:\Program Files\MySQL\MySQL Server X.Y\my.ini"
#
# To install the server as a Windows service manually, execute this in a 
# command line shell, e.g.
# mysqld --install MySQLXY --defaults-file="C:\Program Files\MySQL\MySQL Server X.Y\my.ini"
#
# And then execute this in a command line shell to start the server, e.g.
# net start MySQLXY
#
#
# Guildlines for editing this file
# ----------------------------------------------------------------------
#
# In this file, you can use all long options that the program supports.
# If you want to know the options a program supports, start the program
# with the "--help" option.
#
# More detailed information about the individual options can also be
# found in the manual.
#
# For advice on how to change settings please see
# http://dev.mysql.com/doc/refman/5.7/en/server-configuration-defaults.html
#
#
# CLIENT SECTION
# ----------------------------------------------------------------------
#
# The following options will be read by MySQL client applications.
# Note that only client applications shipped by MySQL are guaranteed
# to read this section. If you want your own MySQL client program to
# honor these values, you need to specify it as an option during the
# MySQL client library initialization.
#
[client]

# pipe
# socket=0.0
port=3306

[mysql]
no-beep

default-character-set=utf8


# SERVER SECTION
# ----------------------------------------------------------------------
#
# The following options will be read by the MySQL Server. Make sure that
# you have installed the server correctly (see above) so it reads this 
# file.
#
# server_type=2
[mysqld]

# The next three options are mutually exclusive to SERVER_PORT below.
# skip-networking

# enable-named-pipe

# shared-memory

# shared-memory-base-name=MYSQL

# The Pipe the MySQL Server will use
# socket=MYSQL

# The TCP/IP Port the MySQL Server will listen on
port=3306

# Path to installation directory. All paths are usually resolved relative to this.
# basedir="C:/Program Files/MySQL/MySQL Server 5.7/"

# Path to the database root
datadir=C:/ProgramData/MySQL/MySQL Server 5.7/Data

# The default character set that will be used when a new schema or table is
# created and no character set is defined
character-set-server=utf8

# The default storage engine that will be used when create new tables when
default-storage-engine=INNODB

# Set the SQL mode to strict
sql-mode="STRICT_TRANS_TABLES,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION"

# Enable Windows Authentication
# plugin-load=authentication_windows.dll

# General and Slow logging.
log-output=FILE
general-log=0
general_log_file="OA.log"
slow-query-log=1
slow_query_log_file="OA-slow.log"
long_query_time=10

# Binary Logging.
# log-bin

# Error Logging.
log-error="OA.err"

# Server Id.
server-id=1

# Secure File Priv.
secure-file-priv="C:/ProgramData/MySQL/MySQL Server 5.7/Uploads"

# The maximum amount of concurrent sessions the MySQL server will
# allow. One of these connections will be reserved for a user with
# SUPER privileges to allow the administrator to login even if the
# connection limit has been reached.
max_connections=1000

# The number of open tables for all threads. Increasing this value
# increases the number of file descriptors that mysqld requires.
# Therefore you have to make sure to set the amount of open files
# allowed to at least 4096 in the variable "open-files-limit" in
# section [mysqld_safe]
table_open_cache=2000

# Maximum size for internal (in-memory) temporary tables. If a table
# grows larger than this value, it is automatically converted to disk
# based table This limitation is for a single table. There can be many
# of them.
tmp_table_size=128M

# How many threads we should keep in a cache for reuse. When a client
# disconnects, the client's threads are put in the cache if there aren't
# more than thread_cache_size threads from before.  This greatly reduces
# the amount of thread creations needed if you have a lot of new
# connections. (Normally this doesn't give a notable performance
# improvement if you have a good thread implementation.)
thread_cache_size=10

#*** MyISAM Specific options
# The maximum size of the temporary file MySQL is allowed to use while
# recreating the index (during REPAIR, ALTER TABLE or LOAD DATA INFILE.
# If the file-size would be bigger than this, the index will be created
# through the key cache (which is slower).
myisam_max_sort_file_size=100G

# If the temporary file used for fast index creation would be bigger
# than using the key cache by the amount specified here, then prefer the
# key cache method.  This is mainly used to force long character keys in
# large tables to use the slower key cache method to create the index.
myisam_sort_buffer_size=32M

# Size of the Key Buffer, used to cache index blocks for MyISAM tables.
# Do not set it larger than 30% of your available memory, as some memory
# is also required by the OS to cache rows. Even if you're not using
# MyISAM tables, you should still set it to 8-64M as it will also be
# used for internal temporary disk tables.
key_buffer_size=16M

# Size of the buffer used for doing full table scans of MyISAM tables.
# Allocated per thread, if a full scan is needed.
read_buffer_size=0

read_rnd_buffer_size=0

#*** INNODB Specific options ***
# innodb_data_home_dir=0.0

# Use this option if you have a MySQL server with InnoDB support enabled
# but you do not plan to use it. This will save memory and disk space
# and speed up some things.
# skip-innodb

# If set to 1, InnoDB will flush (fsync) the transaction logs to the
# disk at each commit, which offers full ACID behavior. If you are
# willing to compromise this safety, and you are running small
# transactions, you may set this to 0 or 2 to reduce disk I/O to the
# logs. Value 0 means that the log is only written to the log file and
# the log file flushed to disk approximately once per second. Value 2
# means the log is written to the log file at each commit, but the log
# file is only flushed to disk approximately once per second.
innodb_flush_log_at_trx_commit=1

# The size of the buffer InnoDB uses for buffering log data. As soon as
# it is full, InnoDB will have to flush it to disk. As it is flushed
# once per second anyway, it does not make sense to have it very large
# (even with long transactions).
innodb_log_buffer_size=1M

# InnoDB, unlike MyISAM, uses a buffer pool to cache both indexes and
# row data. The bigger you set this the less disk I/O is needed to
# access data in tables. On a dedicated database server you may set this
# parameter up to 80% of the machine physical memory size. Do not set it
# too large, though, because competition of the physical memory may
# cause paging in the operating system.  Note that on 32bit systems you
# might be limited to 2-3.5G of user level memory per process, so do not
# set it too high.
innodb_buffer_pool_size=8G

# Size of each log file in a log group. You should set the combined size
# of log files to about 25%-100% of your buffer pool size to avoid
# unneeded buffer pool flush activity on log file overwrite. However,
# note that a larger logfile size will increase the time needed for the
# recovery process.
innodb_log_file_size=48M

# Number of threads allowed inside the InnoDB kernel. The optimal value
# depends highly on the application, hardware as well as the OS
# scheduler properties. A too high value may lead to thread thrashing.
innodb_thread_concurrency=100

# The increment size (in MB) for extending the size of an auto-extend InnoDB system tablespace file when it becomes full.
innodb_autoextend_increment=64

# The number of regions that the InnoDB buffer pool is divided into.
# For systems with buffer pools in the multi-gigabyte range, dividing the buffer pool into separate instances can improve concurrency,
# by reducing contention as different threads read and write to cached pages.
innodb_buffer_pool_instances=8

# Determines the number of threads that can enter InnoDB concurrently.
innodb_concurrency_tickets=5000

# Specifies how long in milliseconds (ms) a block inserted into the old sublist must stay there after its first access before
# it can be moved to the new sublist.
innodb_old_blocks_time=1000

# It specifies the maximum number of .ibd files that MySQL can keep open at one time. The minimum value is 10.
innodb_open_files=300

# When this variable is enabled, InnoDB updates statistics during metadata statements.
innodb_stats_on_metadata=0

# When innodb_file_per_table is enabled (the default in 5.6.6 and higher), InnoDB stores the data and indexes for each newly created table
# in a separate .ibd file, rather than in the system tablespace.
innodb_file_per_table=1

# Use the following list of values: 0 for crc32, 1 for strict_crc32, 2 for innodb, 3 for strict_innodb, 4 for none, 5 for strict_none.
innodb_checksum_algorithm=0

# The number of outstanding connection requests MySQL can have.
# This option is useful when the main MySQL thread gets many connection requests in a very short time.
# It then takes some time (although very little) for the main thread to check the connection and start a new thread.
# The back_log value indicates how many requests can be stacked during this short time before MySQL momentarily
# stops answering new requests.
# You need to increase this only if you expect a large number of connections in a short period of time.
back_log=80

# If this is set to a nonzero value, all tables are closed every flush_time seconds to free up resources and
# synchronize unflushed data to disk.
# This option is best used only on systems with minimal resources.
flush_time=0

# The minimum size of the buffer that is used for plain index scans, range index scans, and joins that do not use
# indexes and thus perform full table scans.
join_buffer_size=2M

# The maximum size of one packet or any generated or intermediate string, or any parameter sent by the
# mysql_stmt_send_long_data() C API function.
max_allowed_packet=4M

# If more than this many successive connection requests from a host are interrupted without a successful connection,
# the server blocks that host from performing further connections.
max_connect_errors=100

# Changes the number of file descriptors available to mysqld.
# You should try increasing the value of this option if mysqld gives you the error "Too many open files".
open_files_limit=4161

# If you see many sort_merge_passes per second in SHOW GLOBAL STATUS output, you can consider increasing the
# sort_buffer_size value to speed up ORDER BY or GROUP BY operations that cannot be improved with query optimization
# or improved indexing.
sort_buffer_size=2M

# The number of table definitions (from .frm files) that can be stored in the definition cache.
# If you use a large number of tables, you can create a large table definition cache to speed up opening of tables.
# The table definition cache takes less space and does not use file descriptors, unlike the normal table cache.
# The minimum and default values are both 400.
table_definition_cache=1400

# Specify the maximum size of a row-based binary log event, in bytes.
# Rows are grouped into events smaller than this size if possible. The value should be a multiple of 256.
binlog_row_event_max_size=8K

# If the value of this variable is greater than 0, a replication slave synchronizes its master.info file to disk.
# (using fdatasync()) after every sync_master_info events.
sync_master_info=10000

# If the value of this variable is greater than 0, the MySQL server synchronizes its relay log to disk.
# (using fdatasync()) after every sync_relay_log writes to the relay log.
sync_relay_log=10000

# If the value of this variable is greater than 0, a replication slave synchronizes its relay-log.info file to disk.
# (using fdatasync()) after every sync_relay_log_info transactions.
sync_relay_log_info=10000

# Indicates how is the InnoDB Cluster configured as (Classic, Sandbox, Master or Slave).
# innodbclustertypeselection=ClassicMySQLReplication

# Indicates how is the InnoDB Cluster is/will be named.
# innodbclustername="sandboxCluster"

# Indicates how many instances will the InnoDB cluster sandbox will have.
# innodbclusterinstances=0

# Holds the InnoDB Cluster Username.
# innodbclusterusername

# Indicates the InnoDB Cluster URI.
# innodbclusteruri

# Indicates the InnoDB Cluster Port.
# innodbclusterport=3306

# Load mysql plugins at start."plugin_x ; plugin_y".
# plugin_load

# MySQL server's plugin configuration.
# loose_mysqlx_port=33060

```




# SQL优化

### explain

在select语句前加上`explain`，可以了解MySQL的基于开销的优化器，还可以获得很多可能被优化器考虑到的访问策略的细节，以及当运行SQL语句时哪种策略预计会被优化器采用。

```sql
EXPLAIN SELECT
	t.*,
	p.statusName AS currStatus 
FROM
	oa_fawen t
	LEFT JOIN oa_flowbase f ON t.flowBaseId = f.id
	LEFT JOIN YNYBJ_EFLOW.t_flowprocess p ON p.id_FlowProcess = f.processId 
WHERE
	f.draftOrgCode = '-' 
	AND EXISTS ( SELECT w.ID_WORKITEM FROM YNYBJ_EFLOW.t_workitem w WHERE f.processId = w.id_FlowProcess AND w.userId = '-' ) 
ORDER BY f.drafterDate DESC 
limit 1,12
```

```sql
+----+--------------------+-------+------------+--------+---------------------------------------------------------------------------+---------------------------------------+---------+------------------------+------+----------+---------------------------------+
| id | select_type        | table | partitions | type   | possible_keys                                                             | key                                   | key_len | ref                    | rows | filtered | Extra                           |
+----+--------------------+-------+------------+--------+---------------------------------------------------------------------------+---------------------------------------+---------+------------------------+------+----------+---------------------------------+
|  1 | PRIMARY            | t     | NULL       | ALL    | i_flowBaseId                                                              | NULL                                  | NULL    | NULL                   | 5885 |   100.00 | Using temporary; Using filesort |
|  1 | PRIMARY            | f     | NULL       | eq_ref | PRIMARY                                                                   | PRIMARY                               | 98      | ynybj_noa.t.flowBaseId |    1 |    10.00 | Using where                     |
|  1 | PRIMARY            | p     | NULL       | eq_ref | PRIMARY                                                                   | PRIMARY                               | 96      | ynybj_noa.f.processId  |    1 |   100.00 | Using where                     |
|  2 | DEPENDENT SUBQUERY | w     | NULL       | ref    | I_T_WORKITEM_FLOW,I_T_WORKITEM_USER,i_processId_unitCode_todoLabel_userId | i_processId_unitCode_todoLabel_userId | 96      | ynybj_noa.f.processId  |   19 |     1.19 | Using where; Using index        |
+----+--------------------+-------+------------+--------+---------------------------------------------------------------------------+---------------------------------------+---------+------------------------+------+----------+---------------------------------+
4 rows in set (0.18 sec)
```

> `id`:选择标识符<br>
> `select_type`:表示查询的类型。<br>
> `table`:输出结果集的表<br>
> `partitions`:匹配的分区<br>
> `type`:表示表的连接类型<br>
> `possible_keys`:表示查询时，可能使用的索引<br>
> `key`:表示实际使用的索引<br>
> `key_len`:索引字段的长度<br>
> `ref`:列与索引的比较<br>
> `rows`:扫描出的行数(估算的行数)<br>
> `filtered`:按表条件过滤的行百分比<br>
> `Extra`:执行情况的描述和说明

##### select_type

> `SIMPLE`:简单SELECT，不使用UNION或子查询等<br>
> `PRIMARY`:子查询中最外层查询，查询中若包含任何复杂的子部分，最外层的select被标记为PRIMARY<br>
> `UNION`:UNION中的第二个或后面的SELECT语句<br>
> `DEPENDENT UNION`:UNION中的第二个或后面的SELECT语句，取决于外面的查询<br>
> `UNION RESULT`:UNION的结果，union语句中第二个select开始后面所有select<br>
> `SUBQUERY`:子查询中的第一个SELECT，结果不依赖于外部查询<br>
> `DEPENDENT SUBQUERY`:子查询中的第一个SELECT，依赖于外部查询<br>
> `DERIVED`:派生表的SELECT, FROM子句的子查询<br>
> `UNCACHEABLE SUBQUERY`:一个子查询的结果不能被缓存，必须重新评估外链接的第一行

##### type

对表的访问类型。

> `ALL`：A full table scan is done for each combination of rows from the previous tables,对涉及到的表进行全表扫描，当表的数据量比较大的时候，全表扫描是比较费时费力的操作，这种情况是我们要避免出现的。<br>
> `index`: A full index scan,对涉及到的索引进行索引扫描，跟ALL类似，在数据量较大的时候也是费时费力的操作，也是需要避免出现的情形。<br>
> `range`:只检索给定范围的行，使用一个索引来选择行<br>system：当表数据只有一行的时候，explain的类型为system<br>
> `const`：当一张表中匹配的数据只有一行的时候，也就是说外层循环只会执行一次。<br>
> `eq_ref`：当表进行join的时候，每次循环取数据的时候只会从表中取出一行，也就是说使用了primary key 和unique key。这是我们比较希望看到的情形<br>
> `ref`：当查询使用到普通索引的时候，一个key值有可能从索引中取出若干行，这也是我们比较希望看到的情况。<br>
> `fulltext`：使用到全文索引的查询。<br>
> `ref_or_null`：类似ref，但是会额外的检查null值。我的观点是null最好避免在数据库中出现，null会进行额外的处理，影响部分性能，没有了null也能避免查询使用ref_or_null的方式来执行。<br>
> `index_merge`：查询使用了一张表的多个索引来取数据。<br>
> `unique_subquery`：当查询语句中有IN操作符的时候，mysql使用unique_subquery来执行查询，是类似ref的一种索引查找方式，适用于unique索引<br>
> `index_subquery`：当查询语句中有IN操作符的时候，mysql使用index_subquery来执行查询，是类似ref的一种索引查找方式，适用于普通索引
>
> 到这里可以结合join_buffer_size的介绍进行部分总结：ALL、index这种操作是最坏情况下的操作，即使使用了join_buffer_size，当数据量较大的情况下也不会有很好的性能。range使用了索引，查询部分数据，使用join_buffer_size是可以提升性能的。所以我们选择调优join_buffer_size参数的原因在于是否使用了很多join type为range的join查询，真实环境还是要结合表的数据量进行具体的评估和测试。
>
> [参数join_buffer_size跟explain结果type的部分联系-visician-ChinaUnix博客](http://blog.chinaunix.net/uid-26253010-id-4039457.html)
>
> [MySQL Explain详解 - 杰克思勒(Jacksile) - 博客园 (cnblogs.com)](https://www.cnblogs.com/tufujie/p/9413852.html)

##### sql_no_cache

在`select`后加上`sql no cache`可以不使用缓存查询，以便观察优化情况

##### 总结

调优 sql 主要在于尽可能使用`where`筛选数据、尽量不出现全表扫描`ALL`和索引扫描`index`，尽量使用`primary key`和`unique key`或索引作表关联、筛选、分组，尽量不查询、不关联无关字段

